name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Ollama
        uses: ai-action/setup-ollama@v2

      - name: Cache Ollama models
        uses: actions/cache@v4
        with:
          path: ~/.ollama
          key: ${{ runner.os }}-ollama-mxbai-embed-large

      - name: Pull embedding model
        run: ollama pull mxbai-embed-large

      - name: Install dependencies
        run: bun install

      - name: Build packages
        run: bun turbo build --filter=opencode-swarm-plugin

      - name: Verify package tarballs
        run: |
          set -euo pipefail
          verify_package() {
            local package_dir="$1"
            local package_name="$2"
            shift 2

            for expected in "$@"; do
              if [ ! -e "$package_dir/$expected" ]; then
                echo "Missing build artifact: $package_dir/$expected"
                exit 1
              fi
            done

            local pack_dir
            pack_dir=$(mktemp -d)

            (cd "$package_dir" && bun pm pack --destination "$pack_dir")

            local tarball
            tarball=$(ls "$pack_dir/${package_name}-"*.tgz)

            if [ -z "$tarball" ]; then
              echo "No tarball produced for ${package_name}"
              exit 1
            fi

            if [ "$(echo "$tarball" | wc -l | tr -d ' ')" -ne 1 ]; then
              echo "Expected a single tarball for ${package_name}, got:"
              echo "$tarball"
              exit 1
            fi

            local contents_file
            contents_file="$pack_dir/contents.txt"
            tar -tzf "$tarball" > "$contents_file"

            for expected in "$@"; do
              grep -q "package/${expected}" "$contents_file"
            done

            rm -rf "$pack_dir"
          }

          verify_package "packages/opencode-swarm-plugin" "opencode-swarm-plugin" "dist/index.js" "dist/index.d.ts" "claude-plugin/dist/"
          verify_package "packages/swarm-mail" "swarm-mail" "dist/index.js" "dist/index.d.ts"

      - name: Type check
        run: bun turbo typecheck

      - name: Run unit tests
        run: bun turbo test
        env:
          AI_GATEWAY_API_KEY: ${{ secrets.AI_GATEWAY_API_KEY }}
          OLLAMA_HOST: http://localhost:11434

      - name: Run eval gates
        id: evals
        run: bun run eval:ci
        continue-on-error: true
        env:
          AI_GATEWAY_API_KEY: ${{ secrets.AI_GATEWAY_API_KEY }}

      - name: Post eval results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const evalResultsPath = 'packages/opencode-swarm-plugin/.hive/eval-results.json';
            
            if (!fs.existsSync(evalResultsPath)) {
              console.log('No eval results found');
              return;
            }
            
            const results = JSON.parse(fs.readFileSync(evalResultsPath, 'utf-8'));
            
            // Format results as markdown table
            let body = '## üêù Eval Gate Results\n\n';
            body += '| Eval | Phase | Score | Status | Message |\n';
            body += '|------|-------|-------|--------|----------|\n';
            
            for (const [evalName, result] of Object.entries(results)) {
              const statusEmoji = result.passed ? '‚úÖ' : '‚ùå';
              const phaseEmoji = result.phase === 'bootstrap' ? 'üå±' : 
                                result.phase === 'stabilization' ? '‚ö°' : 'üèÜ';
              body += `| ${evalName} | ${phaseEmoji} ${result.phase} | ${result.currentScore.toFixed(2)} | ${statusEmoji} | ${result.message} |\n`;
            }
            
            body += '\n---\n';
            body += '*Progressive gates: Bootstrap (always pass) ‚Üí Stabilization (warn) ‚Üí Production (enforce)*';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
